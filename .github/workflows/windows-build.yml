name: Build MPQDraft Windows binary

on:
  push:
  pull_request:
  workflow_dispatch: {}

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.15.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win32_msvc2019'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Build MPQDraft DLL and Stub with MSBuild
        run: |
          msbuild src/dll/MPQDraftDLL.vcxproj /p:Configuration=Release /m
          msbuild src/sempq/stub/MPQStub.vcxproj /p:Configuration=Release /m

      - name: Copy DLL and Stub to src directory for resource embedding
        run: |
          # The .rc file expects MPQDraftDLL.dll and MPQStub.exe in the src directory
          Copy-Item -Path "src/Release/MPQDraftDLL.dll" -Destination "src/MPQDraftDLL.dll" -ErrorAction SilentlyContinue
          Copy-Item -Path "src/dll/Release/MPQDraftDLL.dll" -Destination "src/MPQDraftDLL.dll" -ErrorAction SilentlyContinue
          Copy-Item -Path "src/MPQStub.exe" -Destination "src/MPQStub.exe" -ErrorAction SilentlyContinue
          Copy-Item -Path "src/sempq/stub/Release/MPQStub.exe" -Destination "src/MPQStub.exe" -ErrorAction SilentlyContinue
          # Verify files exist
          if (!(Test-Path "src/MPQDraftDLL.dll")) { Write-Error "MPQDraftDLL.dll not found"; exit 1 }
          if (!(Test-Path "src/MPQStub.exe")) { Write-Error "MPQStub.exe not found"; exit 1 }

      - name: Build MPQDraft Qt GUI with CMake
        run: |
          cmake -B build -S src -A Win32 -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      - name: Set artifact name
        shell: pwsh
        run: |
          # For pull_request events the branch is in GITHUB_HEAD_REF; otherwise extract from GITHUB_REF
          if ($env:GITHUB_EVENT_NAME -eq 'pull_request') {
            $branch = $env:GITHUB_HEAD_REF
          } else {
            $ref = $env:GITHUB_REF
            $branch = $ref -replace 'refs/heads/', ''
          }

          # sanitize branch name (no slashes)
          $branch = $branch -replace '/', '-'

          if ($branch -eq 'main') {
            $timestamp = (Get-Date).ToString('yyyy-MM-dd')
            Add-Content -Path $env:GITHUB_ENV -Value "ARTIFACT_NAME=MPQDraft-release-$timestamp"
          } else {
            $timestamp = (Get-Date).ToString('yyyy-MM-dd-HH-mm-ss')
            Add-Content -Path $env:GITHUB_ENV -Value "ARTIFACT_NAME=MPQDraft-beta-$branch-$timestamp"
          }

      - name: Prepare artifacts
        shell: pwsh
        run: |
          # Create artifact directory
          New-Item -ItemType Directory -Force -Path "artifacts"

          # Get current date in ISO format
          $date = (Get-Date).ToString('yyyy-MM-dd')

          # Copy Qt GUI executable with date in filename
          Copy-Item -Path "build/Release/MPQDraftQt.exe" -Destination "artifacts/MPQDraft-$date.exe"

          # Copy Qt DLLs needed for the application
          & windeployqt --release --no-translations --no-system-d3d-compiler --no-opengl-sw "artifacts/MPQDraft-$date.exe"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: artifacts/*
