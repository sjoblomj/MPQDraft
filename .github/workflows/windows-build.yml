name: Build MPQDraft Windows binary

on:
  push:
  pull_request:
  workflow_dispatch: {}

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.15.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win32_msvc2019'

      - name: Build all with CMake
        run: |
          cmake -B build -S src -A Win32
          cmake --build build --config Release

      - name: Set artifact name
        shell: pwsh
        run: |
          # For pull_request events the branch is in GITHUB_HEAD_REF; otherwise extract from GITHUB_REF
          if ($env:GITHUB_EVENT_NAME -eq 'pull_request') {
            $branch = $env:GITHUB_HEAD_REF
          } else {
            $ref = $env:GITHUB_REF
            $branch = $ref -replace 'refs/heads/', ''
          }

          # sanitize branch name (no slashes)
          $branch = $branch -replace '/', '-'

          if ($branch -eq 'main') {
            $timestamp = (Get-Date).ToString('yyyy-MM-dd')
            Add-Content -Path $env:GITHUB_ENV -Value "ARTIFACT_NAME=MPQDraft-release-$timestamp"
          } else {
            $timestamp = (Get-Date).ToString('yyyy-MM-dd-HH-mm-ss')
            Add-Content -Path $env:GITHUB_ENV -Value "ARTIFACT_NAME=MPQDraft-beta-$branch-$timestamp"
          }

      - name: Prepare artifacts
        shell: pwsh
        run: |
          # Create artifact directory
          New-Item -ItemType Directory -Force -Path "artifacts"

          # Get current date in ISO format
          $date = (Get-Date).ToString('yyyy-MM-dd')
          Add-Content -Path $env:GITHUB_ENV -Value "BUILD_DATE=$date"

          # Copy Qt GUI executable with date in filename
          Copy-Item -Path "build/Release/MPQDraftQt.exe" -Destination "artifacts/MPQDraft-$date.exe"

          # Copy Qt DLLs needed for the application
          & windeployqt --release --no-translations --no-system-d3d-compiler --no-opengl-sw "artifacts/MPQDraft-$date.exe"

      # =========================================================================
      # Enigma Virtual Box - bundles all DLLs into a single executable
      # To disable: comment out or remove the two steps below
      # =========================================================================
      - name: Install Enigma Virtual Box
        shell: pwsh
        run: |
          $evbUrl = "https://enigmaprotector.com/assets/files/enigmavb.exe"
          Invoke-WebRequest -Uri $evbUrl -OutFile "enigmavb_setup.exe"
          Start-Process -FilePath "enigmavb_setup.exe" -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait

      - name: Bundle into single executable
        shell: pwsh
        run: |
          $evbConsole = "C:\Program Files (x86)\Enigma Virtual Box\enigmavbconsole.exe"
          $date = $env:BUILD_DATE
          $inputExe = (Resolve-Path "artifacts/MPQDraft-$date.exe").Path
          $outputExe = (Resolve-Path "artifacts").Path + "\MPQDraft-$date-bundled.exe"

          # Generate and run EVB project
          & .\tools\generate-evb.ps1 -InputExe $inputExe -OutputExe $outputExe -EvbFile "mpqdraft.evb"
          & $evbConsole "mpqdraft.evb"

          # Replace the folder-based artifacts with the single exe
          Get-ChildItem -Path "artifacts" -Exclude "MPQDraft-$date-bundled.exe" | Remove-Item -Recurse -Force
          Rename-Item -Path $outputExe -NewName "MPQDraft-$date.exe"
      # =========================================================================

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: artifacts/*
