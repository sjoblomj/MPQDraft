name: Build MPQDraft Windows binary

on:
  push:
  pull_request:
  workflow_dispatch: {}

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Install Visual Studio MFC components
        shell: pwsh
        run: |
          $installer = 'C:\Program Files (x86)\Microsoft Visual Studio\Installer\vs_installer.exe'
          $vswhere = 'C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe'

          Write-Host "Checking for Visual Studio installer: $installer"
          if (-not (Test-Path $installer)) {
            Write-Host "vs_installer not found at $installer. Skipping install step."
            exit 0
          }

          if (-not (Test-Path $vswhere)) {
            Write-Host "vswhere not found at $vswhere. Skipping install step."
            exit 0
          }

          $inst = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath -format value 2>$null
          if (-not $inst) {
            Write-Host 'No Visual Studio installation found via vswhere. Skipping install step.'
            exit 0
          }

          $instPath = $inst.Trim()
          Write-Host "Found Visual Studio at: $instPath"

          # Component group for Desktop C++ (includes MFC)
          $component0 = 'Microsoft.VisualStudio.ComponentGroup.NativeDesktop.MFC'
          $component1 = 'Microsoft.VisualStudio.Component.VC.14.29.16.11.MFC'
          $args = "modify --installPath `"$instPath`" --add $component0 --add $component1 --passive --norestart"

          Write-Host "Invoking vs_installer: $args"
          $p = Start-Process -FilePath $installer -ArgumentList $args -Wait -PassThru -NoNewWindow
          Write-Host "vs_installer exit code: $($p.ExitCode)"

          if ($p.ExitCode -ne 0) {
            Write-Host 'Visual Studio modify returned non-zero. The hosted runner may not support modifying installed VS. Build may still fail due to missing MFC.'
            # Do not fail the job here; let the build step surface the error with clearer message
          } else {
            Write-Host 'Visual Studio components modified successfully.'
          }

      - name: Build MPQDraft solution
        run: |
          msbuild MPQDraft/MPQDraft.sln /p:Configuration=Release /m

      - name: Set artifact name
        shell: pwsh
        run: |
          # For pull_request events the branch is in GITHUB_HEAD_REF; otherwise extract from GITHUB_REF
          if ($env:GITHUB_EVENT_NAME -eq 'pull_request') {
            $branch = $env:GITHUB_HEAD_REF
          } else {
            $ref = $env:GITHUB_REF
            $branch = $ref -replace 'refs/heads/', ''
          }

          # sanitize branch name (no slashes)
          $branch = $branch -replace '/', '-'

          if ($branch -eq 'main') {
            $timestamp = (Get-Date).ToString('yyyy-MM-dd')
            Add-Content -Path $env:GITHUB_ENV -Value "ARTIFACT_NAME=MPQDraft-release-$timestamp"
          } else {
            $timestamp = (Get-Date).ToString('yyyy-MM-dd-HH-mm-ss')
            Add-Content -Path $env:GITHUB_ENV -Value "ARTIFACT_NAME=MPQDraft-beta-$branch-$timestamp"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            MPQDraft/**/Release/**
